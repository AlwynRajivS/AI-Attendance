<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Face Capture & Recognition</title>
<style>
  body { font-family: Arial,sans-serif; background:#f0f2f5; margin:0; text-align:center; }
  h1 { background:#4CAF50; color:white; padding:15px; margin:0; }
  #video, #overlay { border:2px solid #444; border-radius:10px; margin:10px auto; width:90%; max-width:480px; height:auto; }
  input, button { padding:10px; margin:5px; font-size:16px; border-radius:5px; }
  #descriptorPreview { font-weight:bold; color:green; margin-top:5px; }
  #status { font-weight:bold; color:red; margin:10px; }
  #recognitionCard { margin:10px auto; padding:10px; border-radius:10px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.2); max-width:480px; text-align:left; }
  .camera-buttons { margin:10px; }
  .camera-buttons button { margin:0 5px; }
  @media(max-width:600px){
    #video, #overlay { width:95%; }
    input, button { width:90%; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

<h1>üì∏ Admin ‚Äì Face Capture & Recognition</h1>
<p id="status">‚è≥ Loading models...</p>

<div class="camera-buttons">
  <button id="frontCamBtn">Front Camera</button>
  <button id="backCamBtn">Back Camera</button>
</div>

<video id="video" autoplay muted playsinline></video>
<canvas id="overlay"></canvas>

<div>
  <input type="text" id="studentName" placeholder="Enter Student Name">
  <button id="captureBtn">Capture & Save</button>
</div>

<p id="descriptorPreview">Descriptor Length: 0</p>
<div id="recognitionCard">Recognition: N/A</div>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const statusEl = document.getElementById("status");
const descriptorPreview = document.getElementById("descriptorPreview");
const recognitionCard = document.getElementById("recognitionCard");

const SHEET_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL"; // replace with your deployed GAS URL
let labeledFaceDescriptors = [];
let faceMatcher = null;
let currentStream = null;

// --- Load Face API models ---
async function loadModels(){
  try {
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models/";
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    statusEl.textContent = "‚úÖ Models loaded!";
    await startCamera("user");
    await loadStudentsDescriptors();
    runDetection();
  } catch(err){
    statusEl.textContent = "‚ùå Error loading models: "+err;
    console.error(err);
  }
}

// --- Start camera ---
async function startCamera(facing="user"){ // "user"=front, "environment"=back
  try {
    if(currentStream){
      currentStream.getTracks().forEach(track=>track.stop());
    }
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:facing, width:{ideal:480}, height:{ideal:360} },
      audio:false
    });
    currentStream = stream;
    video.srcObject = stream;
    await new Promise(resolve => video.onloadedmetadata = ()=>resolve());
    video.play();
  } catch(err){
    statusEl.textContent = "‚ùå Webcam error: "+err;
    console.error(err);
  }
}

// --- Load student descriptors ---
async function loadStudentsDescriptors(){
  try {
    const res = await fetch(`${SHEET_URL}?action=getStudents`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    labeledFaceDescriptors = data.map(s => new faceapi.LabeledFaceDescriptors(s.name, [new Float32Array(JSON.parse(s.descriptor))]));
    if(labeledFaceDescriptors.length>0){
      faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
      recognitionCard.textContent = "Recognition: Ready!";
    } else {
      recognitionCard.textContent = "Recognition: No students saved";
    }
  } catch(err){
    console.error("‚ùå Error loading student descriptors:", err);
    recognitionCard.textContent = "Recognition: Error loading students";
  }
}

// --- Detection & Recognition loop ---
async function runDetection(){
  const displaySize = { width: video.width, height: video.height };
  faceapi.matchDimensions(overlay, displaySize);
  setInterval(async()=>{
    if(video.readyState===4){
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors();
      ctx.clearRect(0,0,overlay.width,overlay.height);
      if(detections.length>0){
        const resized = faceapi.resizeResults(detections, displaySize);
        faceapi.draw.drawDetections(overlay, resized);
        faceapi.draw.drawFaceLandmarks(overlay, resized);
        if(faceMatcher){
          const results = resized.map(d=>faceMatcher.findBestMatch(d.descriptor));
          recognitionCard.textContent = "Recognition: " + results.map(r=>r.toString()).join(", ");
        }
      } else {
        recognitionCard.textContent = "Recognition: N/A";
      }
    }
  }, 200);
}

// --- Capture & Save ---
document.getElementById("captureBtn").addEventListener("click", async()=>{
  const name = document.getElementById("studentName").value.trim();
  if(!name) return alert("‚ö†Ô∏è Enter student name");
  try{
    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceDescriptor();
    if(!detection){ alert("‚ùå No face detected"); return; }
    const descriptor = Array.from(detection.descriptor);
    descriptorPreview.textContent = `Descriptor Length: ${descriptor.length}`;
    const response = await fetch(SHEET_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"addStudent", name:name, descriptor:JSON.stringify(descriptor)})
    });
    if(!response.ok) throw new Error(await response.text());
    const result = await response.json();
    alert("‚úÖ Saved "+result.name+" to Google Sheet");
    await loadStudentsDescriptors(); // reload
  } catch(err){ console.error(err); alert("‚ùå Error saving: "+err); }
});

// --- Camera toggle buttons ---
document.getElementById("frontCamBtn").addEventListener("click", ()=>startCamera("user"));
document.getElementById("backCamBtn").addEventListener("click", ()=>startCamera("environment"));

// --- Init ---
document.addEventListener("DOMContentLoaded", loadModels);
</script>

</body>
</html>
